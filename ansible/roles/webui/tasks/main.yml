---
# roles/webui/tasks/main.yml

# Modified version of 
#  - https://github.com/oobabooga/text-generation-webui#manual-installation-using-conda
# Changes:
#  - No conda
#  - Virtualenv
- name: Verify variables
  debug: 
    msg:
     - "webui_dir: {{ webui_dir }}"       # role invocation
     - "webui_repo: {{ webui_repo }}"     # roles/webui/defaults/main.yml
     - "webui_branch: {{ webui_branch }}" # roles/webui/defaults/main.yml

- name: Clone webui
  git:
    repo: "{{ webui_repo }}"   
    dest: "{{ webui_dir }}"     
    single_branch: True
    version: "{{ webui_branch }}"
    # ignore local changes after first checkout
    update: False 

- name: Setup webui venv
  pip:
    requirements: "requirements.txt"
    chdir: "{{ webui_dir }}"
    virtualenv: "{{ webui_dir }}/venv"
    virtualenv_command: "python3 -m venv"

- name: Setup torch for webui
  vars:
    extra_index_url: "https://download.pytorch.org/whl/rocm5.4.2" 
  pip:
    name: 
    - torch
    - torchvision
    - torchaudio
    extra_args: "--extra-index-url={{ extra_index_url }}"
    virtualenv: "{{ webui_dir }}/venv"
    virtualenv_command: "python3 -m venv"

- name: Create symbolic links
  hosts: localhost  # You may need to specify the target hosts here
  tasks:
    - name: Create symbolic links
      file:
        src: "../llm/model/{{ item }}/model/"
        dest: "~/llm/git/webui/models/"
        state: link
      loop:
        - Llama-2-70B-Orca-200k
        - falcon-40b-instruct
        - orca_mini_v3_13b

- name: Deploy systemd service for webui
  template:
    src: "webui.service.j2"
    dest: "/etc/systemd/system/webui.service"
  become: True

- name: Start systemd service for webui
  systemd:
    name: "webui.service"
    daemon_reload: True
    enabled: True
    state: "started"
  become: True
